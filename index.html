<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Messenger Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 30%; border-right: 1px solid #ccc; overflow-y: auto; padding: 10px; }
    .chatbox { flex: 1; display: flex; flex-direction: column; }
    .messages { flex: 1; padding: 10px; overflow-y: auto; }
    .msg { margin: 5px 0; padding: 8px 12px; border-radius: 12px; max-width: 70%; word-wrap: break-word; }
    .in { background: #eee; align-self: flex-start; }
    .out { background: #4e8cff; color: white; align-self: flex-end; }
    .msg.self { background: #a0aec0; color: white; align-self: flex-end; }
    .chat-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #eee; }
    .chat-item:hover { background: #f9f9f9; }
    .chat-item.red { background-color: #ffe5e5; } /* h·ªôi tho·∫°i c√≥ tin m·ªõi */
    .page.red { border-left: 4px solid red; }     /* page c√≥ tin m·ªõi */
    .input-box { display: flex; padding: 10px; border-top: 1px solid #ccc; }
    .input-box input { flex: 1; padding: 8px; }
    .input-box button { margin-left: 5px; padding: 8px 12px; }
    .temp { opacity: 0.6; font-style: italic; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar" id="conversation-list"><strong>Danh s√°ch Page</strong></div>
    <div class="chatbox">
      <div class="messages" id="chat-messages"></div>
      <div class="input-box">
        <input type="text" id="reply-text" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button onclick="sendReply()">G·ª≠i</button>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = "1GqeNGZpbNKkpmsEtZ9CBZUHAQgbNEdbW47Oxdyie1Z8";
    const API_KEY = "AIzaSyBw864zlCeP7ew9LRtEuJoiupO85HLpDF0";
    const SHEET_NAME = "Sheet1";

    const pages = {
      "747951405067264": { name: "Smile Home" },
      "767354809790281": { name: "Smile Home LC" },
      "712112305324720": { name: "Smile Home Care" },
      "567588529767561": { name: "Smile Home Lifestyle" }
    };

    const SEND_WEBHOOK = "https://n8n.cs-fulfill.com/webhook/send-message";

    let allData = [];
    let conversationHashes = {}; // l∆∞u hash ƒë·ªÉ ph√°t hi·ªán thay ƒë·ªïi
    let currentPage = null, currentUser = null;

    // Load d·ªØ li·ªáu t·ª´ Google Sheet
    async function loadData() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
        const res = await fetch(url);
        const json = await res.json();
        if (!json.values) return;

        const headers = json.values[0].map(h => h.trim().toLowerCase());
        allData = json.values.slice(1).map(r => {
          let o = {}; headers.forEach((h, i) => o[h] = r[i] || ""); return o;
        });

        renderPageList();
        if (currentPage && currentUser) {
          showConversation(currentPage, currentUser);
        }
      } catch (e) {
        console.error("Load sheet error:", e);
      }
    }

    // Render danh s√°ch page v√† c√°c user h·ªôi tho·∫°i
    function renderPageList() {
      const convList = document.getElementById("conversation-list");
      convList.innerHTML = "<strong>Danh s√°ch Page</strong>";

      const uniquePages = [...new Set(allData.map(m => m.page_id))];
      uniquePages.forEach(pid => {
        const pageDiv = document.createElement("div");
        pageDiv.className = "page";
        pageDiv.innerHTML = `<h4>${pages[pid]?.name || pid}</h4>`;

        const conversations = [...new Set(allData
          .filter(m => m.page_id === pid && m.user_id !== pid)
          .map(m => `${m.page_id}_${m.user_id}`))]; // gom theo page_id + user_id

        conversations.forEach(key => {
          const [p, uid] = key.split("_");
          const convMsgs = allData.filter(m => m.page_id === p && (m.user_id === uid || m.user_id === p));
          const hash = JSON.stringify(convMsgs);

          const userDiv = document.createElement("div");
          userDiv.className = "chat-item";
          userDiv.textContent = `üë§ User ${uid}`;
          userDiv.onclick = () => {
            showConversation(p, uid);
            userDiv.classList.remove("red"); 
            pageDiv.classList.remove("red");
          };

          if (conversationHashes[key] && conversationHashes[key] !== hash) {
            userDiv.classList.add("red");
            pageDiv.classList.add("red");
          }
          conversationHashes[key] = hash;

          pageDiv.appendChild(userDiv);
        });

        convList.appendChild(pageDiv);
      });
    }

    // Hi·ªÉn th·ªã h·ªôi tho·∫°i chi ti·∫øt
    function showConversation(page_id, user_id) {
      currentPage = page_id;
      currentUser = user_id;

      const msgs = allData.filter(m =>
        m.page_id === page_id &&
        (m.user_id === user_id || m.user_id === page_id)
      );

      const chatBox = document.getElementById("chat-messages");
      chatBox.innerHTML = `<h3>${pages[page_id]?.name || page_id} - User ${user_id}</h3>`;

      msgs.forEach(m => {
        const div = document.createElement("div");

        // ph√¢n bi·ªát theo direction
        const direction = (m.direction || "").toLowerCase();
        if (direction === "send") {
          div.className = "msg out"; // page g·ª≠i
        } else if (direction === "rep") {
          div.className = "msg self"; // page rep
        } else {
          div.className = "msg in"; // kh√°ch g·ª≠i
        }

        div.textContent = m.text || "(tr·ªëng)";
        chatBox.appendChild(div);
      });
    }

    // G·ª≠i tin nh·∫Øn
    async function sendReply() {
      const text = document.getElementById("reply-text").value.trim();
      if (!text || !currentPage || !currentUser) {
        alert("Ch·ªçn h·ªôi tho·∫°i v√† nh·∫≠p tin nh·∫Øn!");
        return;
      }
      const body = { page_id: currentPage, user_id: currentUser, text };
      try {
        await fetch(SEND_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        document.getElementById("reply-text").value = "";

        // append t·∫°m tin nh·∫Øn
        const chatBox = document.getElementById("chat-messages");
        const div = document.createElement("div");
        div.className = "msg out temp";
        div.textContent = text + " (ƒëang g·ª≠i...)";
        chatBox.appendChild(div);
      } catch (e) {
        console.error("Send error:", e);
        alert("‚ùå Kh√¥ng g·ª≠i ƒë∆∞·ª£c tin");
      }
    }

    // Load ban ƒë·∫ßu v√† refresh m·ªói 30s
    loadData();
    setInterval(loadData, 30 * 1000);
  </script>
</body>
</html>
